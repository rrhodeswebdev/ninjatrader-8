#!/bin/bash
#
# Pre-commit hook for backtester-pro
# Validates Python syntax before allowing commits
#
# To install this hook:
#   cp .githooks/pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit
#
# Or use git config:
#   git config core.hooksPath .githooks

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo ""
echo "======================================================================"
echo "  Pre-commit Hook: Python Syntax Validation"
echo "======================================================================"
echo ""

# Find all staged Python files
STAGED_PYTHON_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' || true)

if [ -z "$STAGED_PYTHON_FILES" ]; then
    echo -e "${GREEN}✓ No Python files to check${NC}"
    echo ""
    exit 0
fi

echo "Checking Python files:"
echo "$STAGED_PYTHON_FILES" | sed 's/^/  - /'
echo ""

# Track errors
HAS_ERRORS=0

# Check each file
for FILE in $STAGED_PYTHON_FILES; do
    # Skip deleted files
    if [ ! -f "$FILE" ]; then
        continue
    fi

    echo -n "  Checking $FILE... "

    # Compile Python file to check syntax
    python3 -m py_compile "$FILE" 2>/dev/null

    if [ $? -eq 0 ]; then
        echo -e "${GREEN}✓${NC}"
    else
        echo -e "${RED}✗ SYNTAX ERROR${NC}"
        echo ""
        echo -e "${RED}Syntax error in $FILE:${NC}"
        python3 -m py_compile "$FILE"
        echo ""
        HAS_ERRORS=1
    fi
done

echo ""

# Clean up .pyc files
find . -name "*.pyc" -delete 2>/dev/null || true
find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true

if [ $HAS_ERRORS -eq 1 ]; then
    echo -e "${RED}======================================================================"
    echo "  ✗ COMMIT REJECTED: Python syntax errors detected"
    echo -e "======================================================================${NC}"
    echo ""
    echo "Please fix the syntax errors and try again."
    echo ""
    exit 1
else
    echo -e "${GREEN}======================================================================"
    echo "  ✓ All Python files validated successfully"
    echo -e "======================================================================${NC}"
    echo ""
    exit 0
fi
